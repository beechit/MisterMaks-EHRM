<f:layout name="Ajax"/>

<f:section name="Body">
	<div class="wizard" id="person-wizard">

		<h1>Person wizard</h1>
		<div class="wizard-card" data-cardname="person">
			<h3>Personal data</h3>
			<f:form action="create" object="{person}" name="person">
				<input type="hidden" name="isPersonCreated" value="false" data-validate="isPersonCreated"/>
				<f:render partial="Forms/Person"/>
			</f:form>
		</div>
		<div class="wizard-card" data-cardname="electronicAddress">
			<h3>Electronic addresses</h3>
		</div>
		<div class="wizard-card" data-cardname="address">
			<h3>Addresses</h3>
		</div>
		<div class="wizard-card" data-cardname="phoneNumber">
			<h3>Phone numbers</h3>
		</div>
		<div class="wizard-card" data-cardname="bankAccount">
			<h3>Bank accounts</h3>
		</div>
		<div class="wizard-card" data-cardname="education">
			<h3>Education</h3>
		</div>
		<div class="wizard-card" data-cardname="licence">
			<h3>Licence</h3>
		</div>
		<div class="wizard-error">
			<div class="alert alert-error">
				<strong>There was a problem</strong> with your submission.
				Please correct the errors and re-submit.
			</div>
		</div>

		<div class="wizard-failure">
			<div class="alert alert-error">
				<strong>There was a problem</strong> submitting the form.
				Please try again in a minute.
			</div>
		</div>

		<div class="wizard-success">
			<div class="alert alert-success">
				Person <span class="create-person-name"></span>
				was created <strong>successfully.</strong>
			</div>

			<a class="btn create-another-person">Create another person</a>
			<span style="padding:0 10px">or</span>
			<a class="btn generate-contract">Generate contract</a>
			<span style="padding:0 10px">or</span>
			<a class="btn im-done">Done</a>
		</div>
	</div>
	<script>
		var wizard;

		function isPersonCreated(el) {
			var val = el.val();
			ret = {
				status: false
			};
			if (val === 'false') {
				wizard.cards['person'].el.find('form').submit();
			} else {
				ret.status = true;
			}
			return ret;
		}

		function applyAjaxForm(wizard) {
			wizard.cards['person'].el.find('form').ajaxForm({
				dataType: 'html',
				success: function(result) {
					App.ModuleHandler.loadContent(result, $(wizard.cards['person'].el))
					wizard.entityId = $('input[name="person[__identity]"]').val();
					$.each(wizard.cards, function(index, card) {
						if (card.name != 'person' && card.name != 'finish') {
							card.on('selected', function() {
								App.ModuleHandler.loadUrl('beech.party/administration/' + card.name + '/list.html?party=' + wizard.entityId, $(this.el))
							})
						}
					})
					wizard.incrementCard()
				},
				error: function(result) {
					$(wizard.cards['person'].el).find('form').prepend(result.responseText);
				}
			});
		}

		$(function() {
			$.fn.wizard.logging = false;
			var options = {
				width: 1250,
				increaseHeight: 200,
				submitUrl: 'beech.party/person/list'
			};
			wizard = $("#person-wizard").wizard(options);

			wizard.el.find('.datepicker').on('click', function() {
				$(this).datepicker({showOn:'focus', format: 'dd-mm-yyyy' })
						.on('changeDate', function() {
							$(this).datepicker('hide');
						})
						.focus();
			});
			wizard.el.find('select').chosen({width: '350px'});
			wizard.el.find('.countrySelect').countrySelect();
			wizard.el.find('input').applyInputMasks();

			applyAjaxForm(wizard);

			wizard.show();

			wizard.on("submit", function(wizard) {
				setTimeout(function() {
					wizard.trigger("success");
					wizard.hideButtons();
					wizard._submitting = false;
					wizard.showSubmitCard("success");
					wizard._updateProgressBar(0);
				}, 2000);
			})

			wizard.el.find(".wizard-success .create-another-person").click(function() {
				wizard.reset();
				App.ModuleHandler.loadUrl('/beech.party/administration/person/form.html', $(wizard.cards['person'].el))
				applyAjaxForm(wizard);
			});

			wizard.el.find(".wizard-success .generate-contract").click(function() {
				wizard.reset().close();
				window.location.href = '#/administration/contracts'
			});

			wizard.el.find(".wizard-success .im-done").click(function() {
				wizard.reset().close();
				window.location.href = '#/administration/persons'
			});
		});
	</script>
</f:section>